<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Image Classifier</title>

  <!-- Teachable Machine Library -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 12px; }
    h2 { margin: 10px 0 6px; }
    .small { color: #444; font-size: 14px; margin: 6px 0; }
    .box { border: 1px solid #ccc; border-radius: 12px; padding: 10px; margin-top: 10px; }
    canvas { width: 100%; max-width: 360px; border-radius: 12px; border: 1px solid #ccc; }
    button { font-size: 18px; padding: 10px 18px; border-radius: 10px; cursor: pointer; }
    #all { text-align: left; display: inline-block; margin-top: 8px; font-size: 14px; }
  </style>
</head>

<body>
  <h2>Dog · Cat · Bird · Butterfly</h2>
  <div class="small">Tap “Start Camera”, allow permission, then show your postcard.</div>

  <div class="box">
    <button id="startBtn" onclick="init()">Start Camera</button>
    <div id="status" class="small" style="margin-top:10px;">Status: Waiting…</div>
  </div>

  <div id="webcam-container" class="box"></div>

  <div class="box">
    <h3 id="label">Result: -</h3>
    <p id="confidence">Confidence: -</p>
    <div id="all"></div>
  </div>

  <script>
    // Your Teachable Machine model URL (must end with /)
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/eSlGE_h6S/";

    let model, webcam;
    let isRunning = false;

    async function init() {
      if (isRunning) return; // avoid double start
      isRunning = true;

      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");

      try {
        startBtn.disabled = true;
        statusEl.innerText = "Status: Loading model…";

        const modelURL = MODEL_URL + "model.json";
        const metadataURL = MODEL_URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);

        statusEl.innerText = "Status: Requesting camera permission…";

        const flip = true;
        webcam = new tmImage.Webcam(320, 320, flip);

        // This line triggers the permission popup
        await webcam.setup();
        await webcam.play();

        statusEl.innerText = "Status: Camera running ✅ Show postcard!";
        document.getElementById("webcam-container").innerHTML = "";
        document.getElementById("webcam-container").appendChild(webcam.canvas);

        window.requestAnimationFrame(loop);

      } catch (err) {
        isRunning = false;
        startBtn.disabled = false;

        const msg = (err && err.message) ? err.message : String(err);
        statusEl.innerText = "Status: ERROR ❌ " + msg;

        console.log(err);
        alert("ERROR: " + msg);
      }
    }

    async function loop() {
      if (!webcam || !model) return;
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      // Find best label
      let best = prediction[0];
      for (const p of prediction) if (p.probability > best.probability) best = p;

      document.getElementById("label").innerText = "Result: " + best.className;
      document.getElementById("confidence").innerText =
        "Confidence: " + Math.round(best.probability * 100) + "%";

      // Show all class probabilities
      let txt = "<div id='all'>";
      for (const p of prediction) {
        txt += p.className + ": " + Math.round(p.probability * 100) + "%<br/>";
      }
      txt += "</div>";
      document.getElementById("all").innerHTML = txt;
    }
  </script>
</body>
</html>
